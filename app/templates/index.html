<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>留言板</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>留言板</h1>

  {% if username %}
    <p>您好，{{ username }}！</p>
    {% if is_admin %}
      <a href="{{ url_for('admin_panel') }}"><button>進入管理後台</button></a>
    {% endif %}
    <a href="{{ url_for('logout') }}"><button>登出</button></a>
  {% else %}
    <a href="{{ url_for('login') }}"><button>登入</button></a>
    <a href="{{ url_for('register') }}"><button>註冊</button></a>
  {% endif %}

  <hr>

  <div id="messages"></div>

  {% if username %}
    <form id="msg-form">
      <textarea name="message" required placeholder="請輸入留言..."></textarea><br>
      <button type="submit">送出</button>
    </form>
  {% endif %}

  <script>
    async function loadMessages() {
      const res = await fetch('/messages');
      const data = await res.json();
      const container = document.getElementById('messages');
      container.innerHTML = '';
      data.forEach(([id, user, message, created_at]) => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
          <strong>${user || '匿名'}:</strong> ${message}<br>
          <span class="timestamp">${created_at}</span>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById('msg-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = e.target.message.value;
      const res = await fetch('/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      if (res.ok) {
        e.target.reset();
        loadMessages();
      }
    });

    loadMessages();
    setInterval(loadMessages, 3000);
  </script>
</body>
</html>
